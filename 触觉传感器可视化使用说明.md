# 触觉传感器可视化使用说明

本文档介绍如何使用触觉传感器数据可视化功能。

## 数据结构

从2024年12月开始，触觉传感器数据采用新的分层结构：

```
observation.tactile.{sensor_type}.{sensor_name}.{field}
```

### 支持的传感器类型

#### GelSight传感器（图像型）
- **类型标识**: `gelsight`
- **数据字段**:
  - `tactile_image`: 触觉图像数据 (H, W, 3) uint8格式
  - `sensor_sn`: 传感器序列号
  - `frame_index`: 帧索引
  - `send_timestamp`: 发送时间戳
  - `recv_timestamp`: 接收时间戳

#### Tac3D传感器（力觉型）
- **类型标识**: `tac3d`
- **数据字段**:
  - `positions_3d`: 3D位置数据 (400, 3) float64
  - `displacements_3d`: 3D位移数据 (400, 3) float64  
  - `forces_3d`: 3D力数据 (400, 3) float64
  - `resultant_force`: 合力 (3,) float64，范围 -50N 到 +50N
  - `resultant_moment`: 合力矩 (3,) float64，范围 -10Nm 到 +10Nm

## 数据可视化

使用 `visualize_dataset.py` 脚本来可视化触觉传感器数据：

```bash
# 可视化指定数据集的触觉数据
python lerobot/scripts/visualize_dataset.py \
    --repo-id your_username/your_dataset \
    --episode-index 0

# 限制显示帧数（提高性能）
python lerobot/scripts/visualize_dataset.py \
    --repo-id your_username/your_dataset \
    --episode-index 0 \
    --frame-range 0 100
```

### 显示功能

#### GelSight传感器显示
- 触觉图像的实时显示
- 自动处理CHW/HWC格式转换
- 颜色格式转换（BGR→RGB）
- 图像统计信息（平均亮度、对比度）
- 传感器元数据显示

#### Tac3D传感器显示
- 合力的x、y、z分量可视化
- 合力矩的x、y、z分量可视化
- 数值范围限制和警告提示
- 力和力矩的实时数值显示

## 视频导出功能

### GelSight视频导出工具

使用 `export_gelsight_video.py` 脚本将GelSight触觉图像数据导出为视频文件：

```bash
# 基本使用 - 导出所有GelSight传感器
python export_gelsight_video.py \
    --repo-id your_username/your_dataset \
    --episode-index 0

# 导出特定传感器
python export_gelsight_video.py \
    --repo-id your_username/your_dataset \
    --episode-index 0 \
    --sensor-name main_gripper0

# 自定义视频设置
python export_gelsight_video.py \
    --repo-id your_username/your_dataset \
    --episode-index 0 \
    --fps 60 \
    --quality high \
    --format avi \
    --output-dir ./my_videos
```

### 视频导出参数

#### 格式选项
- `--format`: 视频格式
  - `avi`: AVI格式（默认，最兼容）
  - `mp4`: MP4格式
  - `mov`: MOV格式

#### 编码器说明
- **AVI**: 使用MJPG编码，兼容性最佳
- **MP4**: 使用H.264编码，压缩效果好
- **MOV**: 使用H.264编码，适合Apple设备

#### 质量设置
- `low`: 低质量，小文件大小
- `medium`: 中等质量（默认）
- `high`: 高质量
- `lossless`: 无损质量，大文件大小

#### 其他参数
- `--fps`: 视频帧率（默认30fps）
- `--batch-size`: 批处理大小（默认32）
- `--num-workers`: 工作进程数（默认4）
- `--save-frames`: 保存调试帧用于色彩检查
- `--verbose`: 详细日志输出

### 色彩处理

GelSight视频导出会自动处理色彩格式：

1. **数据源**: GelSight传感器使用FFmpeg的BGR24格式捕获
2. **数据集存储**: 可能转换为RGB格式存储
3. **视频输出**: OpenCV需要BGR格式
4. **自动转换**: 脚本会自动执行RGB→BGR转换

如果色彩显示不正确，可以使用 `--save-frames` 参数保存调试帧进行检查。

### 输出示例

```bash
✅ Successfully exported 1 video(s):
  📹 gelsight_videos/your_dataset_episode_0_gelsight_main_gripper0.avi (764K)
```

#### 视频信息
- **格式**: AVI (Motion JPEG编码)
- **分辨率**: 320x240
- **帧率**: 30fps
- **时长**: 根据数据集帧数自动计算
- **兼容性**: 所有主流播放器和操作系统

### 调试功能

如果遇到色彩或格式问题，可以使用调试功能：

```bash
# 保存前几帧为图像文件用于调试
python export_gelsight_video.py \
    --repo-id your_username/your_dataset \
    --episode-index 0 \
    --save-frames \
    --verbose
```

这会在输出目录生成：
- `debug_frame_X_sensor_bgr.png`: BGR格式的调试帧
- `debug_frame_X_sensor_rgb.png`: RGB格式的调试帧

## 故障排除

### 常见问题

1. **没有触觉数据**: 确保数据集包含触觉传感器数据
2. **数据格式错误**: 检查数据是否使用新的分层结构
3. **视频播放问题**: 
   - 尝试使用AVI格式（最兼容）
   - 检查系统是否安装了相应的编解码器
4. **色彩显示错误**: 使用 `--save-frames` 参数检查调试帧

### 性能优化

1. **大数据集**: 增加 `--batch-size` 和 `--num-workers`
2. **存储空间**: 使用较低的质量设置
3. **处理速度**: 减少worker进程数如果内存不足

## 兼容性说明

- 支持新的分层触觉数据结构
- 向后兼容旧的数据格式
- 自动检测和适配不同的传感器类型
- 跨平台支持（Linux、Windows、macOS） 