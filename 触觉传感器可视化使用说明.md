# 触觉传感器数据可视化使用说明

## 概述

更新后的 `visualize_dataset.py` 脚本支持新的分层触觉传感器数据结构，能够清晰地显示不同类型传感器的数据。

## 支持的数据结构

### 新的分层结构
```
observation.tactile.{sensor_type}.{name}.{field}
```

其中：
- `sensor_type`: 传感器类型（"gelsight" 或 "tac3d"）
- `name`: 传感器名称（如 "main_gripper0", "main_gripper1"）
- `field`: 数据字段名称

### Tac3D传感器支持的字段
- `resultant_force`: 合力的x、y、z分量 (3,) float64
- `resultant_moment`: 合力矩的x、y、z分量 (3,) float64
- `sensor_sn`: 传感器序列号（字符串）

### GelSight传感器支持的字段
- `tactile_image`: 触觉图像 (H, W, 3) uint8 或 (3, H, W) float32
- `frame_index`: 帧索引号
- `recv_timestamp`: 接收时间戳
- `send_timestamp`: 发送时间戳
- `sensor_sn`: 传感器序列号

## 可视化内容

### Tac3D传感器可视化
- **力分量图表**: `tactile/tac3d/{sensor_name}/force_{x/y/z}`
  - 显示xyz三个方向的力分量
  - 数值范围：-50N 到 +50N（可调节）
  - 超出范围的值会被限制并显示警告

- **力矩分量图表**: `tactile/tac3d/{sensor_name}/moment_{x/y/z}`
  - 显示xyz三个方向的力矩分量
  - 数值范围：-10Nm 到 +10Nm（可调节）
  - 超出范围的值会被限制并显示警告

### GelSight传感器可视化
- **触觉图像**: `tactile/gelsight/{sensor_name}/tactile_image`
  - 显示RGB触觉图像（自动从BGR格式转换）
  - 支持CHW和HWC格式自动转换
  - 支持float32和uint8数据类型
  - 自动处理GelSight设备的BGR->RGB色彩空间转换

- **图像统计**: 
  - `tactile/gelsight/{sensor_name}/mean_brightness`: 平均亮度
  - `tactile/gelsight/{sensor_name}/contrast`: 对比度（标准差）

- **元数据图表**:
  - `tactile/gelsight/{sensor_name}/frame_index`: 帧索引
  - `tactile/gelsight/{sensor_name}/recv_timestamp`: 接收时间戳
  - `tactile/gelsight/{sensor_name}/send_timestamp`: 发送时间戳

- **传感器信息**: `tactile/{sensor_type}/{sensor_name}/sensor_info`
  - 显示传感器序列号等文本信息

## 使用示例

### 1. 本地可视化
```bash
python lerobot/scripts/visualize_dataset.py \
    --repo-id kirdo/TEST-Tactile3 \
    --episode-index 0
```

### 2. 保存为.rrd文件
```bash
python lerobot/scripts/visualize_dataset.py \
    --repo-id kirdo/TEST-Tactile3 \
    --episode-index 0 \
    --save 1 \
    --output-dir ./visualization_output
```

然后使用以下命令查看：
```bash
rerun ./visualization_output/kirdo_TEST-Tactile3_episode_0.rrd
```

### 3. 远程可视化（通过SSH转发）
在远程机器上：
```bash
python lerobot/scripts/visualize_dataset.py \
    --repo-id kirdo/TEST-Tactile3 \
    --episode-index 0 \
    --mode distant \
    --ws-port 9087
```

在本地机器上（先建立SSH隧道）：
```bash
ssh -L 9087:localhost:9087 username@remote-host
rerun ws://localhost:9087
```

## 数据浏览结构

可视化数据将按以下结构组织：

```
├── 相机数据
│   ├── observation.image.laptop
│   └── ... 其他相机
├── 机器人状态
│   ├── action/0, action/1, ...
│   ├── state/0, state/1, ...
│   ├── next.done
│   ├── next.reward
│   └── next.success
└── 触觉传感器
    ├── tactile/tac3d/main_gripper1/
    │   ├── force_x, force_y, force_z
    │   ├── moment_x, moment_y, moment_z
    │   └── sensor_info
    └── tactile/gelsight/main_gripper0/
        ├── tactile_image
        ├── mean_brightness
        ├── contrast
        ├── frame_index
        ├── recv_timestamp
        ├── send_timestamp
        └── sensor_info
```

## 注意事项

1. **数据范围限制**: 力和力矩值有预设的显示范围，超出范围的值会被限制并在控制台显示警告。

2. **图像格式**: 脚本自动处理不同的图像格式（CHW/HWC，float32/uint8），确保正确显示。

3. **色彩空间处理**: GelSight传感器使用BGR格式（FFmpeg bgr24），脚本自动转换为RGB格式以正确显示色彩。

4. **性能优化**: 使用批处理加载数据，可以通过 `--batch-size` 和 `--num-workers` 参数调节性能。

5. **内存管理**: 大数据集建议使用保存模式而不是实时可视化，避免内存溢出。

## 自定义配置

如果需要调整力值或力矩值的显示范围，可以修改脚本中的以下参数：

```python
# Tac3D力值范围
min_force = -50.0  # 最小力值
max_force = 50.0   # 最大力值

# Tac3D力矩范围  
min_moment = -10.0  # 最小力矩
max_moment = 10.0   # 最大力矩
```

根据具体的传感器规格和应用需求进行调整。 